# Rustici course migration

This script facilitates the migration of existing e-learning within the CSL learning catalogue to Rustici Engine. This is required as the launch process for courses is changing with the upgrade to Rustici Engine. The new launch process requires that courses are uploaded to Rustici, therefore existing courses and e-learning materials must be registered to Rustici.

## Requirements

- Python 3
- Python packages - `pip install -r requirements.txt`

## Data

This script relies on two data sources, a blob storage containing all of the e-learning zip files and a database with a `migration` table in.

### E-learning zip blob storage

The blob storage should simply contain all of the proposed zip files for the e-learning post-Rustici. The connection string for the blob storage account can be found in the Azure portal.

### Database table

The database table should have the following columns:

|column|description|
|-|-|
|id|ID of the row|
|course_id|The course ID|
|module_id|The E-Learning module ID to be migrated|
|zip_file_name|The name of the e-learning zip file, corresponding to the [E-learning zip blob storage](#e-learning-zip-blob-storage)|
|existing_media_id|The existing media ID of the existing zip file in Elasticsearch. The media ID is generated by the course catalogue at the point of upload. During the migration process, the new zips will be uploaded to the catalogue, thus generating a new media_id. This column stores the existing media_id for rollback/reset purposes|
|media_id|The new media_id resulting from the new zip upload|
|manifest_file|The manifest file from the new zip upload. Required for the Rustici Engine upload|
|rustici_course_id|The Rustici course ID. Generated after the e-learning has been uploaded to Rustici Engine. Is a compound key made up of `<course_id>.<module_id>`|

## Script

The script can be executed using the `python main.py <args>` CLI command, after changing to the `app` directory.

The script has two main functions, `upload` and `reset`. The `upload` function migrates rows in the database, making sure to leave any details that have already been completed (i.e if the row has a `media_id`, the media will not be reuploaded to the catalogue.). Reset will reset the Rustici course upload for the specified module(s) and will optionally reset the zip upload.

Help for the below commands can be accessed using the `-h` flag alongside the command.

### upload

The `upload` command manages migration of existing e-learning modules into Rustici. Each module has a zip file which points to a blob storage zip file.

To upload all of the uploadable candidates in the database:
```upload```

To upload modules ABCD and DEFG in the database:
```upload --modules ABCD DEFG`

### reset

The `reset` command resets the current migration to its pre-rustici state. This includes:
- Deleting the course from Rustici Engine
- With the `--zip-upload` argument:
  - Deleting the blob that was created from `POST /media`
  - Reverting the module's media_id to its previous value

The `reset` command can only be used with specific module IDs - it is only intended for spot-fixing modules.

To delete the Rustici Engine course entry for modules ABCD and DEFG:
```reset ABCD DEFG```

To reset module ABCD completely, including deleting the new blob and resetting the media ID:
```reset ABCD --zip-upload```

### check

The `check` command is a utility command that provides a quick way to check the status of the database migrations. It will print a verbatim output of the database into the console. The `--check-zip` flag can be passed to check if a zip is present in the blob storage account.

To check the status of all migrations:
```check```

To check the status of module ABCD:
```check ABCD```

To check if the zip file for migration module ABCD is present in the blob storage account:
```check ABCD --check-zip```

### setup

The setup command will create the `migration` database table in the `migration_env` database. `<env>` is the environment provided by the environment variable `ENVIRONMENT`.

## Tests

To run the unit tests for this application (after installing `requirements.txt`):

`cd app`
`python -m pytest testing`